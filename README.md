# Univi√ßosa Laravel Payment Client

`univicosa/laravel-payment-client` is a Laravel package which created to integrate the Payment server to ours Laravel project's that requires payments requests.

## Install

Installation using composer:

```
composer require univicosa/laravel-payment-client
```

For Laravel versions < 5.5 add the service provider in `config/app.php`:

```
Modules\OpenId\Providers\OpenIdServiceProvider::class
```

Define the system in your `.env` setting the enviroiment variables: 

`SYSTEM_ID` generated by Admin server for your system
`SYSTEM_PASSWORD` generated by Admin server for your system
`PAYMENT_SERVER` defined according to enviroiment you are using

To personalize the config, publish the package's configuration file by running:

```
php artisan vendor:publish --tag=payment
```

The file `config/openid.php` will be generated.

**PS:** Your system need to be authorized by the Payment Administration Service and uses the OpenId Client to authenticate the users that request the payments.

## Creating a new account

For do payments requests the client need to use a valid Beneficiary. For create one on demand just implement the `Payment::createBeneficiary()` method following the rules:

```php
'name'        => 'bail|required|string|min:5', // The name that describes your beneficiary in the report list
'system'      => 'bail|required|string|size:24', // The id that the Payment server admin provides to you
'account'     => 'bail|required|string', // The bank account that Payment server admin provides to you
'valid_until' => 'bail|required|date|after:now', // The final date your account will accepts payments requests
```

## Payment requests

To request a payment to the server via API client you should instantiate one of the avaliable types and pass to the driver via `\Payment::send()` Facade. The driver will identify the instance of your payment and send to the appropriated endpiont.

The request accepts N items by request, turning possible a client use a cart of items in one unique payment instance.

The Payment request should follow the rules for all Payment instances. All types available will extends:

```php
'payer.name'              => 'bail|required|string|min:3',
'payer.address'           => 'bail|required|string|min:3',
'payer.district'          => 'bail|required|string|min:2',
'payer.cep'               => 'bail|required|string|min:8|max:9|cep',
'payer.state'             => 'bail|required|string|min:2',
'payer.city'              => 'bail|required|string|min:3',
'payer.cpf'               => 'bail|required|string|size:11|cpf',
'value'                   => 'bail|required|numeric|min:0',
'operator'                => 'bail|required|string', // the financier operator of your transaction. EX: SICOOB, Cielo
'items'                   => 'bail|required|array|min:1',
'items.*.name'            => 'bail|required|string|min:3',
'items.*.amount'          => 'bail|required|numeric|min:0',
'items.*.discount_amount' => 'bail|required|numeric|min:0',
'items.*.final_value'     => 'bail|required|numeric|min:0',
'items.*.discounts'       => 'bail|filled|array|min:1',
'items.*.beneficiary'     => 'bail|required|string|size:24',
'items.*.details'         => 'bail|required|array|min:1',
'items.*.details.*.item'  => 'bail|required|string|min:3',
'items.*.details.*.value' => 'bail|required|numeric|min:0',
```

## Payment types availiable

All the following types will extends the default rules of Payment class.

### Boleto

All current payments via boleto accepts only the SICOOB operator and the return methods are operated manually. The notification of payment are maded after that and can wait 72 hour for the bank return.

```php
'descriptions'               => 'bail|required|array|min:1|max:4', // add the descriptions to boleto's document body
'descriptions.*.description' => 'bail|required|string|min:5',
'deadline'                   => 'bail|required|integer|min:0', // defines the deadline for your boleto be payed in days
```

**PS:** if the deadline recognizes the final date as a not util day, the end date will be the next monday.

### Credit card

All current payments via credit card accpts the brands American Express, Diners Club, Discover, JCB, MasterCard, Visa, Elo and Aura.

```php
'credit_card.cvv'        => 'bail|required|digits_between:3,4',
'credit_card.brand'      => 'bail|required|string',
'credit_card.number'     => 'bail|required|digits_between:13,16|card',
'credit_card.holder'     => 'bail|required|string|min:5',
'credit_card.expiration' => 'bail|required|date_format:m/Y|after_or_equal:now',
'installments'           => 'bail|required|integer|min:1|max:6',
```

### Debit card

All current payments via debit card accepts only the brands MasterCard and Visa and will requires an additional validation by the user in their corresponding Bank.

```php
'debit_card.cvv'        => 'bail|required|digits_between:3,4',
'debit_card.brand'      => 'bail|required|string,
'debit_card.number'     => 'bail|required|digits_between:13,16|card',
'debit_card.holder'     => 'bail|required|string|min:5',
'debit_card.expiration' => 'bail|required|date_format:m/Y|after_or_equal:now',
'debit_card.callback'   => 'bail|required|url', // the callback route for the operator's redirect. Ex: /payment/recieved.html
```

### Free

The free payment is a instance that receives isents requests generated with 100% discount (vouchers included) and just extends the default rules and need to receive the 'value' key as a zero.

```php
'value' => 'bail|required|numeric|min:0|max:0'
```

### Presential

The presential payment are maided by authorized users under a admin panel and accepts payment in cash (type => 'money') or via card machine (type => 'credit_card' and type => 'debit_card') and excluded the following parent rules: 'payer.address', 'payer.district', 'payer.cep', 'payer.state' and 'payer.city'.

```php
'presential.type'              => 'bail|required|string',
'presential.installments'      => 'bail|required|integer|min:1',
'presential.responsible.name'  => 'bail|required|string|min:3',
'presential.responsible.email' => 'bail|required|string|email',
'presential.responsible.cpf'   => 'bail|required|string|size:11|cpf',
```

## Payment status

Each payment type has a especific line of status updates, but their all will respects the following rules:

Payments payed or scheduled receive a 'payed' status.
Payments canceled, refunded or closed receive a 'canceled' status.
Payments aborted or denied receive a 'denied' status.
All the other possibles status are translated to a 'waiting' status.

The status 'payed', 'canceled' and 'denied' are endpoints and not receives new notifications after updated.

## Payment push notification

The driver implements a route `/api/payment` that receives the push notifications with the change of payments status from the Payment server. The notification contains the payment_id and the updated status.

The method and controller that will treat the return need to be defined in the published `config/payment.php` file.
